<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:p="http://www.springframework.org/schema/p"
       xsi:schemaLocation="	http://www.springframework.org/schema/beans 
       						http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       						http://www.springframework.org/schema/context
           					http://www.springframework.org/schema/context/spring-context-2.5.xsd
           					http://www.springframework.org/schema/util 
           					http://www.springframework.org/schema/util/spring-util-2.5.xsd 
   						    http://camel.apache.org/schema/spring 		
 						    http://camel.apache.org/schema/spring/camel-spring.xsd">

	<context:annotation-config/>

	<bean id="handler" class="com.villemos.sdms.doccrawler.ExtendedCrawlerHandler"/>
	<bean id="extractor" class="com.villemos.sdms.doccrawler.DocumentProcessor"/>	
	<bean id="constant.fields" class="com.villemos.sdms.doccrawler.enricher.ConstantFields">
		<property name="constantFields">
			<map>
				<entry key="doc.ieOrganisation" value="Lotus"/>
			</map>
		</property>
	</bean>
	
	<bean id="title.matcher" class="com.villemos.sdms.doccrawler.enricher.PatternBasedEnricher">
		<property name="headerFieldName" value="doc.hdUrl"/>
		<property name="pattern" value="\\(\d+) (.+?)\\(\d+) (.+?)\\"/>
		<property name="groups">
			<map>
				<entry key="2" value="doc.ieProject"/>
				<entry key="4" value="doc.ieSetgType"/>
			</map>
		</property>
	</bean>
	
	<bean id="property.fields" class="com.villemos.sdms.doccrawler.enricher.MicrosoftPropertyReader"/>
	<bean id="solr.storage" class="com.villemos.sdms.core.datamodel.SolrStorer"/>

	<bean id="fileStore" class="org.apache.camel.processor.idempotent.FileIdempotentRepository">
	    <!-- the filename for the store -->
	    <property name="fileStore" value="c:/test/store/.filestore.dat"/>
	    <!-- the max filesize in bytes for the file. Camel will trunk and flush the cache
         if the file gets bigger -->
	    <property name="maxFileStoreSize" value="512000"/>
	    <!-- the number of elements in our store -->
	    <property name="cacheSize" value="250"/>
	</bean>

	<camelContext id="context" xmlns="http://camel.apache.org/schema/spring">
		<template id="producer"/>

		<route id="FileReader">
			<from uri="file://c:/test/testdata?recursive=true&amp;noop=true&amp;consumer.delay=60000&amp;idempotent=true&amp;idempotentRepository=#fileStore" />
			<to uri="bean:extractor"/>
		</route>

		<!-- The extractor will for each file received, eject one or more (for example when processing compressed 
		     files) documents into the 'seda:injection' endpoint. -->
		
		<route>
			<from uri="seda:injection"/>			
			<to uri="bean:constant.fields"/>
			<to uri="bean:title.matcher"/>
			<!-- to uri="bean:property.fields"/ -->
			<to uri="direct:doc.out"/>			
		</route>
		
		<route>
			<from uri="direct:doc.out"/>
			<to uri="bean:solr.storage"/>
		</route>
		
		<route>
			<from uri="direct:test.doc.out"/>
			<to uri="mock:doc.out"/>
		</route>
					
	</camelContext>
	
</beans>